//! 写作计划自动生成引擎
//!
//! 根据用户选择的主题和天数，自动生成渐进式写作计划。
//! 内置多种主题模板，从基础到进阶逐步提升。

use crate::errors::AppResult;
use crate::models::plan::*;

/// 根据请求生成写作计划
pub fn generate_writing_plan(req: &GeneratePlanRequest) -> AppResult<ImportPlanRequest> {
    let templates = get_templates_for_theme(&req.theme);
    let total = req.total_days as usize;

    let mut days = Vec::new();
    for i in 0..total {
        let template = &templates[i % templates.len()];
        days.push(ImportPlanDayItem {
            day: (i + 1) as i32,
            title: template.0.to_string(),
            prompt: template.1.to_string(),
        });
    }

    Ok(ImportPlanRequest {
        name: req.name.clone(),
        theme: Some(req.theme.clone()),
        start_date: req.start_date.clone(),
        days,
    })
}

/// 获取指定主题的写作模板库
///
/// 返回 (题目, 写作提示) 的列表，按难度渐进排列。
fn get_templates_for_theme(theme: &str) -> Vec<(&'static str, &'static str)> {
    match theme {
        "叙事" | "narrative" => narrative_templates(),
        "议论" | "argumentative" => argumentative_templates(),
        "描写" | "descriptive" => descriptive_templates(),
        "创意" | "creative" => creative_templates(),
        "日记" | "diary" => diary_templates(),
        _ => comprehensive_templates(),
    }
}

/// 叙事写作模板（由浅入深）
fn narrative_templates() -> Vec<(&'static str, &'static str)> {
    vec![
        // --- 第1周：基础叙事 ---
        ("自我介绍", "用 500 字介绍你自己。包括你的性格特点、兴趣爱好和生活态度。试着用一个小故事来展现你是谁。"),
        ("早晨时光", "描述你某个典型的早晨。从睁开眼到出门，记录每一个细节和感受。"),
        ("一顿难忘的饭", "回忆一顿让你印象深刻的饭。是什么场合？和谁一起？为什么难忘？"),
        ("童年的一个午后", "描写童年记忆中一个具体的下午。你在哪里？在做什么？周围有什么声音和气味？"),
        ("第一次独自出行", "回忆你第一次独自远行的经历。出发前的心情、路途中的见闻和到达后的感受。"),
        ("一次争吵", "叙述一次与他人的争吵或矛盾。起因、过程、结果，以及事后的反思。"),
        ("一个改变我的人", "写一个对你人生产生重要影响的人。通过具体事件展现他/她如何改变了你。"),
        // --- 第2周：进阶叙事 ---
        ("雨中的故事", "以下雨天为背景，写一个发生在你身上的真实故事。注意环境描写与情感表达的融合。"),
        ("一个秘密", "分享一个你长久保守的秘密，或者你发现别人秘密的经历。"),
        ("失去的时刻", "写一次失去某样东西（物品、机会、关系）的经历。真诚地表达那份失落。"),
        ("等待", "描写一段漫长等待的经历。你在等什么？等待过程中的心理变化是怎样的？"),
        ("一张旧照片", "拿出一张旧照片（真实或想象的），围绕它讲述背后的故事。"),
        ("夜归", "写一次深夜回家的经历。路上的所见所闻，内心的想法。"),
        ("重逢", "叙述一次与久别之人重逢的场景。相见前的期待和相见后的感受。"),
        // --- 第3周：复杂叙事 ---
        ("转折点", "写你人生中的一个重要转折点。在那个时刻之前和之后，你发生了怎样的变化？"),
        ("两难的选择", "叙述一次让你左右为难的选择。你权衡了什么？最终如何决定？"),
        ("误解", "写一段因误解而产生波折的经历。事情的真相是什么？误解如何解开？"),
        ("陌生人的善意", "回忆一个陌生人对你展现善意的时刻。那份善意对你产生了什么影响？"),
        ("失败的经验", "详细叙述一次失败的过程。你学到了什么？如果重来你会怎么做？"),
        ("一封未寄出的信", "以书信的形式，写你一直想对某个人说却没说出口的话。"),
        ("十年前的今天", "想象或回忆十年前的今天你在做什么，与现在的自己对话。"),
        // --- 第4周：深度叙事 ---
        ("城市与我", "以你所在的城市为背景，写你与这座城市之间的故事。"),
        ("家的味道", "通过食物的味道来叙述关于家的记忆。"),
        ("一本书如何改变了我", "写一本深刻影响你的书。不是书评，而是你与这本书之间的故事。"),
        ("四季之歌", "选择你最喜欢的季节，用叙事的方式展现这个季节对你的意义。"),
        ("告别", "写一次告别的场景。可以是毕业、搬家、分手或生离死别。"),
        ("给未来的自己", "给十年后的自己写一段叙事。想象那时的生活，回望此刻。"),
        ("我的故事", "用第三人称的视角重新讲述你人生中最重要的一段经历。"),
        ("三个瞬间", "选择你人生中三个最重要的瞬间，用叙事将它们串联起来。"),
        ("如果那天不同", "选择一个过去的关键时刻，想象如果你做了不同的选择，故事会如何展开。"),
        ("未完成的旅程", "写一段你尚未完成但一直挂念的事。"),
    ]
}

/// 议论写作模板
fn argumentative_templates() -> Vec<(&'static str, &'static str)> {
    vec![
        ("阅读还有意义吗？", "在短视频盛行的时代，深度阅读是否仍然重要？阐述你的观点并给出论据。"),
        ("远程办公的未来", "远程办公是否会成为未来的主流工作方式？从效率、生活质量和社会影响等角度论述。"),
        ("AI 与创造力", "人工智能能否拥有真正的创造力？你认为 AI 创作的作品算不算艺术？"),
        ("教育的本质", "你认为教育的核心目的是什么？知识传授、能力培养还是人格塑造？"),
        ("社交媒体的代价", "社交媒体让我们更连接还是更孤独？结合你的观察给出论述。"),
        ("成功的定义", "社会对'成功'的定义正在改变吗？你心中的成功是什么样的？"),
        ("技术与隐私", "在享受技术便利的同时，我们应该为隐私做出多大的让步？"),
        ("独处的价值", "独处是浪费时间还是自我成长的必要条件？"),
        ("传统与创新", "在文化传承中，传统和创新如何平衡？"),
        ("快餐文化反思", "快节奏生活的利与弊，我们是否需要慢下来？"),
        ("竞争与合作", "在职场和生活中，竞争和合作哪个更重要？"),
        ("环境保护的责任", "个人在环境保护中应该承担多大的责任？"),
        ("碎片化学习", "碎片化学习是有效的学习方式吗？论述其利弊。"),
        ("理想与现实", "追求理想与接受现实之间，如何找到平衡？"),
        ("自由的边界", "个人自由应该有边界吗？在什么情况下应该被限制？"),
    ]
}

/// 描写写作模板
fn descriptive_templates() -> Vec<(&'static str, &'static str)> {
    vec![
        ("窗外的风景", "描写此刻你窗外的景色。注意光线、色彩和空间层次。"),
        ("一个街角", "描写你常经过的一个街角。包括建筑、行人、声音和气味。"),
        ("雨后的世界", "描写雨后初晴的场景。注意水洼的倒影、空气的味道和光线的变化。"),
        ("一双手", "描写一双你熟悉的人的手。通过手的细节展现这个人的性格和经历。"),
        ("清晨的菜市场", "描写一个繁忙的菜市场。色彩、声音、人物和生活气息。"),
        ("深夜的城市", "描写深夜城市的某个角落。与白天有什么不同？"),
        ("一棵老树", "描写一棵你熟悉的老树。它的形态、光影、以及它见证了什么。"),
        ("咖啡馆一隅", "描写一家咖啡馆的内部。从一个座位的视角出发。"),
        ("夕阳下的人", "描写一个在夕阳下的人物剪影。"),
        ("季节的转换", "描写你感受到某个季节正在交替的那个瞬间。"),
        ("一间老屋", "描写你记忆中的一间老房子。"),
        ("风", "描写风。不同季节、不同场景的风有什么不同？"),
        ("一场雪", "描写一场你经历过的雪。或者想象中的雪。"),
        ("人群", "在一个拥挤的公共场所，描写你观察到的人群。"),
        ("静物", "选择你手边的一个物品，像画家一样用文字描绘它。"),
    ]
}

/// 创意写作模板
fn creative_templates() -> Vec<(&'static str, &'static str)> {
    vec![
        ("那扇门背后", "以'我推开那扇门'开头，写一个 500 字以上的短故事。"),
        ("最后一班地铁", "一个人在最后一班地铁上遇到了一个奇怪的乘客。发生了什么？"),
        ("时间旅行者的便利店", "想象一家只在凌晨三点出现的便利店，店主似乎来自另一个时代。"),
        ("未发送的消息", "一条打了又删、删了又打的消息背后，藏着什么故事？"),
        ("二十年后的同学会", "想象二十年后参加同学会的场景。大家都变成了什么样？"),
        ("一封来自未来的信", "你收到了一封来自三十年后自己寄来的信。信里写了什么？"),
        ("消失的一天", "如果你的生命中有一天突然消失了，你会选择哪一天？为什么？"),
        ("平行世界的我", "在另一个平行世界，你过着完全不同的生活。那是怎样的？"),
        ("写给外星人的说明书", "如果要向一个外星人解释'人类的一天'，你会怎么写？"),
        ("一件会说话的旧物", "以第一人称，让一件旧物品讲述它经历过的故事。"),
        ("颠倒的城市", "想象一座一切都颠倒的城市。规则、习惯、日夜……"),
        ("最后的书店", "写一个关于'世界上最后一家书店'的故事。"),
        ("梦境记录", "尽可能详细地还原你最近的一个梦。"),
        ("声音的故事", "选择一个声音（警笛、蝉鸣、钢琴声……），围绕它写一个故事。"),
        ("微型小说", "用恰好 100 个字，写一个完整的故事。"),
    ]
}

/// 日记写作模板
fn diary_templates() -> Vec<(&'static str, &'static str)> {
    vec![
        ("今日感悟", "记录今天让你印象最深的一件事，以及它给你的感悟。"),
        ("情绪日记", "今天你经历了哪些情绪变化？试着用文字捕捉每一刻的感受。"),
        ("感恩清单", "写下今天你想感恩的五件事，并详细说明为什么。"),
        ("如果重来", "如果今天可以重来，你会改变什么？"),
        ("致明天的我", "给明天的自己写一段话。你希望明天的自己做什么？"),
        ("观察日记", "仔细观察今天遇到的一个人，描写他/她的外貌、行为和你的猜测。"),
        ("学习笔记", "总结今天学到的最重要的一件事。"),
        ("对话复盘", "回忆今天一段有意义的对话。你们说了什么？你有什么新的思考？"),
        ("身体感知", "今天你的身体感觉如何？尝试用文字描述身体的感受。"),
        ("白日梦", "记录你今天的一个白日梦或随想。"),
        ("本周回顾", "回顾过去一周的生活，总结收获和遗憾。"),
        ("阅读感想", "分享你最近阅读内容的感想。可以是书、文章或任何文字。"),
        ("未完成的事", "写下一件你一直拖延没做的事，分析为什么。"),
        ("给陌生人的信", "给今天遇到的一个陌生人写一封不会寄出的信。"),
        ("当下此刻", "用五分钟，不加思考地写下此刻脑海中涌现的所有想法。"),
    ]
}

/// 综合写作模板（混合各类型）
fn comprehensive_templates() -> Vec<(&'static str, &'static str)> {
    let mut all = Vec::new();
    let sources = vec![
        narrative_templates(),
        argumentative_templates(),
        descriptive_templates(),
        creative_templates(),
        diary_templates(),
    ];

    // 轮流取每个类别，实现交错排列
    let max_len = sources.iter().map(|s| s.len()).max().unwrap_or(0);
    for i in 0..max_len {
        for source in &sources {
            if i < source.len() {
                all.push(source[i]);
            }
        }
    }

    all
}
